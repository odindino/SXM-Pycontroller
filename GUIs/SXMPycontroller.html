<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>SMU Controller</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --bg-color: #ecf0f1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .connection-panel {
            grid-column: 1 / -1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .channel-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .input-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group label {
            min-width: 120px;
            color: var(--primary-color);
        }

        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex-grow: 1;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: var(--secondary-color);
            color: white;
            transition: background-color 0.2s;
            min-width: 100px;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.success { background-color: var(--success-color); }
        button.warning { background-color: var(--warning-color); }
        button.danger { background-color: var(--danger-color); }

        .reading-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }

        .reading-display div {
            margin: 5px 0;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-connected { background-color: var(--success-color); }
        .status-disconnected { background-color: var(--danger-color); }

        .timestamp {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Connection Panel -->
        <div class="connection-panel">
            <h2>Connection Settings</h2>
            <div class="input-group">
                <label>VISA Address:</label>
                <input type="text" id="visaAddress" placeholder="TCPIP0::172.30.32.98::inst0::INSTR" value="TCPIP0::172.30.32.98::inst0::INSTR">
                <button id="connectBtn">Connect</button>
                <button id="disconnectBtn" class="danger" disabled>Disconnect</button>
                <span id="connectionStatus" class="status-indicator status-disconnected"></span>
            </div>
            <!-- <div class="input-group">
                <label>Compliance:</label>
                <input type="number" id="compliance" step="0.001" min="0" value="0.1">
                <span>A</span>
                <button id="setComplianceBtn">Set Compliance</button>
            </div> -->
        </div>

        <!-- Channel 1 Panel -->
        <div class="channel-panel">
            <h2>Channel 1 (Source-Drain)</h2>
            <div class="input-group">
                <label>Mode:</label>
                <select id="ch1Mode">
                    <option value="VOLTAGE">Voltage</option>
                    <option value="CURRENT">Current</option>
                </select>
            </div>
            <div class="input-group">
                <label>Output Value:</label>
                <input type="number" id="ch1Value" step="0.001" value="0.5">
                <span id="ch1Unit">V</span>
                <button id="ch1SetBtn">Set</button>
            </div>
            <div class="input-group">
                <label>Compliance:</label>
                <input type="number" id="ch1Compliance" step="0.001" min="0" value="0.01">
                <span>A</span>
                <button id="ch1SetComplianceBtn">Set</button>
                <button id="ch1ReadComplianceBtn">Read</button>
            </div>
            <div class="input-group">
                <button id="ch1OutputBtn" class="warning">Output OFF</button>
                <button id="ch1ReadBtn" onclick="readChannel(1)">Read Values</button>
            </div>
            <div class="reading-display">
                <div>Voltage: <span id="ch1Voltage">0.000000 V</span></div>
                <div>Current: <span id="ch1Current">0.000000 μA</span></div>
                <div class="timestamp">Last Read: <span id="ch1LastRead">Never</span></div>
            </div>
        </div>

        <!-- Channel 2 Panel -->
        <div class="channel-panel">
            <h2>Channel 2 (Gate)</h2>
            <div class="input-group">
                <label>Mode:</label>
                <select id="ch2Mode">
                    <option value="VOLTAGE">Voltage</option>
                    <option value="CURRENT">Current</option>
                </select>
            </div>
            <div class="input-group">
                <label>Output Value:</label>
                <input type="number" id="ch2Value" step="0.001" value="1">
                <span id="ch2Unit">V</span>
                <button id="ch2SetBtn">Set</button>
            </div>
            <div class="input-group">
                <label>Compliance:</label>
                <input type="number" id="ch2Compliance" step="0.001" min="0" value="0.01">
                <span>A</span>
                <button id="ch2SetComplianceBtn">Set</button>
                <button id="ch2ReadComplianceBtn">Read</button>
            </div>
            <div class="input-group">
                <button id="ch2OutputBtn" class="warning">Output OFF</button>
                <button id="ch2ReadBtn" onclick="readChannel(2)">Read Values</button>
            </div>
            <div class="reading-display">
                <div>Voltage: <span id="ch2Voltage">0.000000 V</span></div>
                <div>Current: <span id="ch2Current">0.000000 μA</span></div>
                <div class="timestamp">Last Read: <span id="ch2LastRead">Never</span></div>
            </div>
        </div>

        <!-- STM Control Panel -->
        <div class="channel-panel">
            <h2>STM Control</h2>
            <div class="input-group">
                <button id="stsStartBtn" class="success">Start STS</button>
            </div>
        </div>
    </div>

    <script>
        // 全域狀態管理
        const state = {
            connected: false,
        };

        // DOM元素
        const elements = {
            visaAddress: document.getElementById('visaAddress'),
            connectBtn: document.getElementById('connectBtn'),
            disconnectBtn: document.getElementById('disconnectBtn'),
            connectionStatus: document.getElementById('connectionStatus'),
            ch1: {
                mode: document.getElementById('ch1Mode'),
                value: document.getElementById('ch1Value'),
                unit: document.getElementById('ch1Unit'),
                setBtn: document.getElementById('ch1SetBtn'),
                outputBtn: document.getElementById('ch1OutputBtn'),
                readBtn: document.getElementById('ch1ReadBtn'),
                voltage: document.getElementById('ch1Voltage'),
                current: document.getElementById('ch1Current'),
                lastRead: document.getElementById('ch1LastRead'),
                compliance: document.getElementById('ch1Compliance'),
                setComplianceBtn: document.getElementById('ch1SetComplianceBtn'),
                readComplianceBtn: document.getElementById('ch1ReadComplianceBtn')
            },
            ch2: {
                mode: document.getElementById('ch2Mode'),
                value: document.getElementById('ch2Value'),
                unit: document.getElementById('ch2Unit'),
                setBtn: document.getElementById('ch2SetBtn'),
                outputBtn: document.getElementById('ch2OutputBtn'),
                readBtn: document.getElementById('ch2ReadBtn'),
                voltage: document.getElementById('ch2Voltage'),
                current: document.getElementById('ch2Current'),
                lastRead: document.getElementById('ch2LastRead'),
                compliance: document.getElementById('ch2Compliance'),
                setComplianceBtn: document.getElementById('ch2SetComplianceBtn'),
                readComplianceBtn: document.getElementById('ch2ReadComplianceBtn')
            },
            stsStartBtn: document.getElementById('stsStartBtn')
        };

        // 更新連接狀態UI
        function updateConnectionStatus(connected) {
            try {
                state.connected = connected;
                
                // 更新狀態指示器
                if (elements.connectionStatus) {
                    elements.connectionStatus.className = `status-indicator status-${connected ? 'connected' : 'disconnected'}`;
                }
                
                // 更新連接按鈕
                if (elements.connectBtn) {
                    elements.connectBtn.disabled = connected;
                }
                if (elements.disconnectBtn) {
                    elements.disconnectBtn.disabled = !connected;
                }
                
                // 更新通道控制項
                ['ch1', 'ch2'].forEach(channelId => {
                    const ch = elements[channelId];
                    if (ch) {
                        // 確保每個元素存在再設置狀態
                        if (ch.setBtn) ch.setBtn.disabled = !connected;
                        if (ch.outputBtn) ch.outputBtn.disabled = !connected;
                        if (ch.readBtn) ch.readBtn.disabled = !connected;
                        if (ch.mode) ch.mode.disabled = !connected;
                        if (ch.value) ch.value.disabled = !connected;
                        if (ch.setComplianceBtn) ch.setComplianceBtn.disabled = !connected;
                        if (ch.readComplianceBtn) ch.readComplianceBtn.disabled = !connected;
                        if (ch.compliance) ch.compliance.disabled = !connected;
                    }
                });
                
            } catch (error) {
                console.error('Error updating connection status:', error);
            }
        }


        function setupChannelEvents(channelNum) {
            const ch = elements[`ch${channelNum}`];
            
            // Compliance控制
            ch.setComplianceBtn.addEventListener('click', async () => {
                try {
                    const value = parseFloat(ch.compliance.value);
                    await pywebview.api.set_compliance(channelNum, value);
                    console.log(`Set channel ${channelNum} compliance to ${value}A`);
                } catch (error) {
                    alert(`設定compliance失敗: ${error}`);
                }
            });

            ch.readComplianceBtn.addEventListener('click', async () => {
                try {
                    const value = await pywebview.api.get_compliance(channelNum);
                    ch.compliance.value = value.toFixed(3);
                    console.log(`Channel ${channelNum} compliance: ${value}A`);
                } catch (error) {
                    alert(`讀取compliance失敗: ${error}`);
                }
            });
        }    
        // 單次讀值功能
        async function readChannel(channel) {
            try {
                const btn = document.getElementById(`ch${channel}ReadBtn`);
                btn.disabled = true;
                btn.textContent = 'Reading...';
                
                const reading = await pywebview.api.read_channel(channel);
                
                // 電壓保持6位小數
                document.getElementById(`ch${channel}Voltage`).textContent = 
                    `${reading.voltage.toFixed(6)} V`;
                    
                // 電流轉換為μA並顯示6位小數
                const currentInMicroAmps = reading.current * 1e6;
                document.getElementById(`ch${channel}Current`).textContent = 
                    `${currentInMicroAmps.toFixed(6)} μA`;
                    
                document.getElementById(`ch${channel}LastRead`).textContent = 
                    new Date().toLocaleTimeString();
                    
            } catch (error) {
                alert(`讀值失敗: ${error}`);
            } finally {
                const btn = document.getElementById(`ch${channel}ReadBtn`);
                btn.disabled = false;
                btn.textContent = 'Read Values';
            }
        }

        // 事件處理器
        // 連接處理函數
        async function handleConnect() {
            try {
                const address = elements.visaAddress.value.trim();
                if (!address) {
                    alert('請輸入VISA地址');
                    return;
                }
                
                elements.connectBtn.disabled = true;
                elements.connectBtn.textContent = '連接中...';
                
                await pywebview.api.connect_smu(address);
                updateConnectionStatus(true);
                
            } catch (error) {
                alert('連接失敗: ' + error);
                updateConnectionStatus(false);
            } finally {
                elements.connectBtn.disabled = false;
                elements.connectBtn.textContent = 'Connect';
            }
        }

        // 斷開連接處理函數
        async function handleDisconnect() {
            try {
                elements.disconnectBtn.disabled = true;
                elements.disconnectBtn.textContent = '斷開中...';
                
                await pywebview.api.disconnect_smu();
                updateConnectionStatus(false);
                
            } catch (error) {
                alert('斷開連接失敗: ' + error);
            } finally {
                elements.disconnectBtn.disabled = false;
                elements.disconnectBtn.textContent = 'Disconnect';
            }
        }

        function setupChannelEvents(channelNum) {
            const ch = elements[`ch${channelNum}`];
            
            // 模式變更處理
            ch.mode.addEventListener('change', () => {
                ch.unit.textContent = ch.mode.value === 'VOLTAGE' ? 'V' : 'A';
            });

            // 設定輸出值
            ch.setBtn.addEventListener('click', async () => {
                try {
                    await pywebview.api.set_channel_value(
                        channelNum,
                        ch.mode.value,
                        parseFloat(ch.value.value)
                    );
                } catch (error) {
                    alert(`設定通道 ${channelNum} 失敗: ${error}`);
                }
            });

            // 輸出開關
            ch.outputBtn.addEventListener('click', async () => {
                try {
                    const newState = ch.outputBtn.textContent === 'Output OFF';
                    await pywebview.api.set_channel_output(channelNum, newState);
                    ch.outputBtn.textContent = `Output ${newState ? 'ON' : 'OFF'}`;
                    ch.outputBtn.className = newState ? 'success' : 'warning';
                } catch (error) {
                    alert(`切換輸出 ${channelNum} 失敗: ${error}`);
                }
            });
        }

        // 初始化
        function initialize() {
            // 設置事件監聽器
            elements.connectBtn.addEventListener('click', handleConnect);
            elements.disconnectBtn.addEventListener('click', handleDisconnect);
            
            // 設置通道事件
            setupChannelEvents(1);
            setupChannelEvents(2);
            
            // Compliance設置
            elements.setComplianceBtn.addEventListener('click', async () => {
                try {
                    await pywebview.api.set_compliance(parseFloat(elements.compliance.value));
                } catch (error) {
                    alert('設定限制值失敗: ' + error);
                }
            });

            // STS控制
            elements.stsStartBtn.addEventListener('click', async () => {
                try {
                    await pywebview.api.start_sts();
                } catch (error) {
                    alert('啟動STS失敗: ' + error);
                }
            });

            // 初始化UI狀態
            updateConnectionStatus(false);
        }

        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>